
{% load static %}

{% load tz %}
{% now "d/m/Y H:i:s" as now %}



<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Controle Mensal - {{ mes_nome }} {{ ano }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  </head>
  <body class="bg-light">
    <div class="container mt-4">

        <div class="d-flex align-items-center mb-3">
          <span>Ol√°, {{ user.username }}!</span>
            <a href="{% url 'logout' %}" class="btn btn-outline-danger btn-sm">Sair</a>
        </div>

      <!-- Navega√ß√£o de meses -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <a href="{% url 'mes_navegar' ano=ano_anterior mes=mes_anterior %}" class="btn btn-outline-primary btn-lg">‚¨ÖÔ∏è {{ mes_anterior_nome }}</a>

        <h1>Controle Mensal - {{ mes_nome }} {{ ano }}</h1>

          <a href="{% url 'mes_navegar' ano=ano_proximo mes=mes_proximo %}" class="btn btn-outline-primary btn-lg">{{ mes_proximo_nome }} ‚û°Ô∏è</a>
      </div>

      <!-- Totais do m√™s com previs√µes -->
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="card shadow">
            <div class="card-body text-center">
              <h5 class="card-title text-success">Entradas</h5>
              <p class="fs-4">
                R$ {{ total_entradas }} <small class="text-muted">(Previsto: {{ total_prev_entradas }})</small>
              </p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card shadow">
            <div class="card-body text-center">
              <h5 class="card-title text-danger">Sa√≠das</h5>
              <p class="fs-4">
                R$ {{ total_saidas }} <small class="text-muted">(Previsto: {{ total_prev_saidas }})</small>
              </p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card shadow">
            <div class="card-body text-center">
              <h5 class="card-title text-info">Guardar</h5>
              <p class="fs-4">
                R$ {{ total_guardar }} <small class="text-muted">(Previsto: {{ total_prev_guardar }})</small>
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Bot√£o para gr√°fico -->
      <div class="text-end mb-3">
        <a href="{% url 'grafico_mes' ano=ano mes=mes %}" class="btn btn-primary">üìä Ver Gr√°fico</a>
        
      </div>
    
      <!-- Tabela de transa√ß√µes -->
      <div class="card shadow mb-4">
        <div class="card-body">
          <div class = "d-flex justify-content-center mb-3">
            <button type="button" class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#modalNovaTransacao">+ Nova Transa√ß√£o</button>
          </div>

          <h4 class="mb-3">üìã Transa√ß√µes</h4> 
          
          
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Data</th>
                <th>Descri√ß√£o</th>
                <th>Categoria</th>
                <th>Valor</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody>
              {% for t in transacoes %}
                <tr>
                  <td>{{ t.data }}</td>
                  <td>{{ t.descricao }}</td>
                  <td>{{ t.get_categoria_display }}</td>
                  <td>R$ {{ t.valor|floatformat:2 }}</td>
                  <td>
                    <button type="button" class="btn btn-sm btn-warning" onclick="abrirModalEditar({{ t.id }}, '{{ t.descricao }}', {{ t.valor }}, '{{ t.data }}', '{{ t.categoria }}', {{ t.pago|yesno:'true,false' }})">‚úèÔ∏è</button>
                    <button type="button" class="btn btn-sm btn-danger" onclick="abrirModalExcluir({{ t.id }}, '{{ t.descricao }}')">üóëÔ∏è</button>
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="5" class="text-center text-muted">Nenhuma transa√ß√£o neste m√™s</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Tabela de previs√µes -->
      <div class="card shadow mb-4">
        <div class="card-body">
          <h4 class="mb-3">üîÆ Previs√µes</h4>
          <table class="table table-light">
            <thead>
              <tr>
                <th>Descri√ß√£o</th>
                <th>Categoria</th>
                <th>Valor Previsto</th>
              </tr>
            </thead>
            <tbody>
              {% for p in previsoes %}
                <tr>
                  <td>{{ p.descricao }}</td>
                  <td>{{ p.get_categoria_display }}</td>
                  <td>R$ {{ p.valor_previsto|floatformat:2 }}</td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="3" class="text-center text-muted">Nenhuma previs√£o neste m√™s</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Modal Nova Transa√ß√£o -->
  <div class="modal fade" id="modalNovaTransacao" tabindex="-1" aria-labelledby="modalNovaTransacaoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form method="POST" action="{% url 'nova_transacao' %}">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title" id="modalNovaTransacaoLabel">Nova Transa√ß√£o</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label>Descri√ß√£o</label>
              <input type="text" name="descricao" class="form-control" required />
            </div>
            <div class="mb-3">
              <label>Valor</label>
              <input type="number" step="0.01" name="valor" class="form-control" required />
            </div>
            <div class="mb-3">
              <label>Data</label>
              <input type="date" name="data" class="form-control" required />
            </div>
            <div class="mb-3">
              <label>Categoria</label>
              <select name="categoria" class="form-select" required>
                <option value="receita">Receita</option>
                <option value="despesa">Despesa</option>
              </select>
            </div>
            <div class="mb-3 form-check">
              <input type="checkbox" name="pago" class="form-check-input" id="pagoNova" />
              <label class="form-check-label" for="pagoNova">Pago?</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-success">Salvar</button>
          </div>
        </form>
      </div>
    </div>
  </div>


    <!-- Modal √önico de Edi√ß√£o -->
    <div class="modal fade" id="modalEditar" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form method="POST" id="formEditar">
            {% csrf_token %}
            <input type="hidden" name="transacao_id" id="editar_id" />
            <div class="modal-header">
              <h5 class="modal-title">Editar Transa√ß√£o</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label>Descri√ß√£o</label>
                <input type="text" name="descricao" class="form-control" id="editar_descricao" required />
              </div>
              <div class="mb-3">
                <label>Valor</label>
                <input type="number" step="0.01" name="valor" class="form-control" id="editar_valor" required />
              </div>
              <div class="mb-3">
                <label>Data</label>
                <input type="date" name="data" class="form-control" id="editar_data" required />
              </div>
              <div class="mb-3">
                <label>Categoria</label>
                <select name="categoria" class="form-select" id="editar_categoria" required>
                  <option value="receita" {% if transacao.categoria == 'receita' %}selected{% endif %}>Receita</option>
                  <option value="despesa" {% if transacao.categoria == 'despesa' %}selected{% endif %}>Despesa</option>
                </select>
              </div>
              <div class="form-check mb-3">
                <input type="checkbox" name="pago" class="form-check-input" id="editar_pago" />
                <label class="form-check-label" for="editar_pago">Pago?</label>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-success">Salvar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal √önico de Exclus√£o -->
    <div class="modal fade" id="modalExcluir" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirmar Exclus√£o</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="corpoExcluir"></div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <a href="#" class="btn btn-danger" id="btnConfirmarExcluir">Excluir</a>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function abrirModalEditar(id, descricao, valor, data, categoria, pago) {
        document.getElementById('editar_id').value = id
        document.getElementById('editar_descricao').value = descricao
        document.getElementById('editar_valor').value = valor
        document.getElementById('editar_data').value = data
        document.getElementById('editar_categoria').value = categoria
        document.getElementById('editar_pago').checked = pago
        new bootstrap.Modal(document.getElementById('modalEditar')).show()
      }
      
      function abrirModalExcluir(id, descricao) {
        document.getElementById('corpoExcluir').innerHTML = `Tem certeza que deseja excluir a transa√ß√£o "<strong>${descricao}</strong>"?`
        document.getElementById('btnConfirmarExcluir').href = `/excluir/${id}/`
        new bootstrap.Modal(document.getElementById('modalExcluir')).show()
      }
    </script>
  </body>
</html>
