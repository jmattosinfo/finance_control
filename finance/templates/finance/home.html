{% extends 'finance/base.html' %}
{% load static %}
{% block content %}
  <div class="container">
    <div class="text-center mb-4">
      <h1>üí∞ Controle Financeiro</h1>

      <!-- Bot√£o Nova Transa√ß√£o -->
      <button type="button" class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#modalNovaTransacao">+ Nova Transa√ß√£o</button>
    </div>

    <!-- Cards de resumo -->
    <div class="row text-center mb-4">
      <div class="col-md-4">
        <div class="card border-success">
          <div class="card-body">
            <h5 class="card-title text-success">Entradas</h5>
            <p class="fs-4">R$ {{ total_entradas|floatformat:2 }}</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card border-danger">
          <div class="card-body">
            <h5 class="card-title text-danger">Despesas</h5>
            <p class="fs-4">R$ {{ total_despesas|floatformat:2 }}</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card border-info">
          <div class="card-body">
            <h5 class="card-title text-info">Saldo</h5>
            <p class="fs-4 {% if saldo < 0 %}
                text-danger
              {% else %}
                text-success
              {% endif %}">R$ {{ saldo|floatformat:2 }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabela de transa√ß√µes -->
    <div class="card shadow">
      <div class="card-body">
        <h4 class="mb-3">üìã Transa√ß√µes</h4>
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Descri√ß√£o</th>
              <th>Valor</th>
              <th>Data</th>
              <th>Categoria</th>
              <th>Pago?</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            {% for t in transacoes %}
              <tr>
                <td>{{ t.descricao }}</td>
                <td>R$ {{ t.valor|floatformat:2 }}</td>
                <td>{{ t.data }}</td>
                <td>{{ t.get_categoria_display }}</td>
                <td>
                  {% if t.pago %}
                    ‚úÖ
                  {% else %}
                    ‚ùå
                  {% endif %}
                </td>
                <td>
                  <!-- Bot√£o de editar -->
                  <button type="button" class="btn btn-sm btn-warning btn-editar" data-bs-toggle="modal" data-bs-target="#modalEditar" data-id="{{ t.id }}" data-descricao="{{ t.descricao }}" data-valor="{{ t.valor }}" data-data="{{ t.data|date:'Y-m-d' }}" data-categoria="{{ t.categoria }}" data-pago="{{ t.pago }}">‚úèÔ∏è</button>

                  <!-- Bot√£o de excluir -->
                  <button type="button" class="btn btn-sm btn-danger btn-excluir" data-bs-toggle="modal" data-bs-target="#modalExcluir" data-id="{{ t.id }}" data-descricao="{{ t.descricao }}">üóëÔ∏è</button>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="6" class="text-center text-muted">Nenhuma transa√ß√£o cadastrada ainda.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal Nova Transa√ß√£o -->
  <div class="modal fade" id="modalNovaTransacao" tabindex="-1" aria-labelledby="modalNovaTransacaoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form method="POST" action="{% url 'nova_transacao' %}">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title" id="modalNovaTransacaoLabel">Nova Transa√ß√£o</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label>Descri√ß√£o</label>
              <input type="text" name="descricao" class="form-control" required />
            </div>
            <div class="mb-3">
              <label>Valor</label>
              <input type="number" step="0.01" name="valor" class="form-control" required />
            </div>
            <div class="mb-3">
              <label>Data</label>
              <input type="date" name="data" class="form-control" required />
            </div>
            <div class="mb-3">
              <label>Categoria</label>
              <select name="categoria" class="form-select" required>
                <option value="receita">Receita</option>
                <option value="despesa">Despesa</option>
              </select>
            </div>
            <div class="mb-3 form-check">
              <input type="checkbox" name="pago" class="form-check-input" id="pagoNova" />
              <label class="form-check-label" for="pagoNova">Pago?</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-success">Salvar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal √∫nico de Edi√ß√£o -->
  <div class="modal fade" id="modalEditar" tabindex="-1" aria-labelledby="modalEditarLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form method="POST" id="formEditar">
          {% csrf_token %}
          <input type="hidden" name="transacao_id" id="editarId" />
          <div class="modal-header">
            <h5 class="modal-title" id="modalEditarLabel">Editar Transa√ß√£o</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label>Descri√ß√£o</label>
              <input type="text" name="descricao" class="form-control" id="editarDescricao" required />
            </div>
            <div class="mb-3">
              <label>Valor</label>
              <input type="number" step="0.01" name="valor" class="form-control" id="editarValor" required />
            </div>
            <div class="mb-3">
              <label>Data</label>
              <input type="date" name="data" class="form-control" id="editarData" required />
            </div>
            <div class="mb-3">
              <label>Categoria</label>
              <select name="categoria" class="form-select" id="editarCategoria" required>
                <option value="receita">Receita</option>
                <option value="despesa">Despesa</option>
              </select>
            </div>
            <div class="mb-3 form-check">
              <input type="checkbox" name="pago" class="form-check-input" id="editarPago" />
              <label class="form-check-label" for="editarPago">Pago?</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-success">Salvar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal √∫nico de Exclus√£o -->
  <div class="modal fade" id="modalExcluir" tabindex="-1" aria-labelledby="modalExcluirLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalExcluirLabel">Confirmar exclus√£o</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body" id="excluirBody"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <a href="#" class="btn btn-danger" id="btnConfirmarExcluir">Excluir</a>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // URLs din√¢micas usando Django
    const urlEditarBase = "{% url 'editar_transacao' 0 %}"
    const urlExcluirBase = "{% url 'excluir_transacao' 0 %}"
    
    // Modal edi√ß√£o
    document.querySelectorAll('.btn-editar').forEach((btn) => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id
        const descricao = btn.dataset.descricao
        const valor = btn.dataset.valor
        const data = btn.dataset.data
        const categoria = btn.dataset.categoria
        const pago = btn.dataset.pago === 'True'
    
        document.getElementById('editarId').value = id
        document.getElementById('editarDescricao').value = descricao
        document.getElementById('editarValor').value = valor
        document.getElementById('editarData').value = data
        document.getElementById('editarCategoria').value = categoria
        document.getElementById('editarPago').checked = pago
    
        document.getElementById('formEditar').action = urlEditarBase.replace('0', id)
      })
    })
    
    // Modal exclus√£o
    document.querySelectorAll('.btn-excluir').forEach((btn) => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id
        const descricao = btn.dataset.descricao
    
        document.getElementById('excluirBody').innerHTML = `Tem certeza que deseja excluir a transa√ß√£o <strong>"${descricao}"</strong>?`
    
        document.getElementById('btnConfirmarExcluir').href = urlExcluirBase.replace('0', id)
      })
    })
  </script>
{% endblock %}
